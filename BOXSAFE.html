<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Boxsafe</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1b1b2b;
      color: #eee;
      text-align: center;
      padding: 30px;
    }
    h1 { color: #7ee0ff; }
    .panel {
      max-width: 800px;
      margin: auto;
      background: #2c2c3c;
      padding: 20px;
      border-radius: 10px;
    }
    textarea, input[type="password"], input[type="email"], input[type="text"] {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 6px;
      border: none;
    }
    input[type="file"] {
      margin: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px;
      border: none;
      background: #4CAF50;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
    canvas {
      display: none;
    }
    img {
      max-height: 200px;
      margin: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>Boxsafe</h1>
  <div class="panel">
    <div id="acceso">
      <h3>Validar acceso</h3>
      <input type="email" id="correo" placeholder="Tu correo"><br>
      <input type="text" id="codigo" placeholder="Código de acceso"><br>
      <button onclick="validarID()">Ingresar</button>
    </div>
<div id="contenido" style="display:none;">
      <h3>Ocultar mensaje</h3>
      <textarea id="mensaje" placeholder="Escribe tu mensaje aquí..."></textarea><br>
      <input type="password" id="clave" placeholder="Clave secreta"><br>
      <input type="file" id="imagenInput" accept="image/*"><br>
      <button onclick="ocultar()">Ocultar</button><br><br>
      <div id="result"></div>
      <hr>
      <h3>Leer mensaje</h3>
      <input type="file" id="imagenLectura" accept="image/*"><br>
      <input type="password" id="claveLectura" placeholder="Clave secreta"><br>
      <button onclick="leer()">Leer</button>
      <textarea id="mensajeSalida" placeholder="Aquí aparecerá tu mensaje..." readonly></textarea><br>
      <button onclick="editar()">Editar y volver a ocultar</button>
    </div>
  </div>

  <canvas id="canvas"></canvas>
  <script>
    async function validarID() {
      const correo = document.getElementById("correo").value.trim();
      const codigo = document.getElementById("codigo").value.trim();
      try {
        const [resp, horaResp] = await Promise.all([
          fetch("https://openai-sandbox.github.io/data/accesos_boxsafe.json"),
          fetch("https://worldtimeapi.org/api/timezone/Etc/UTC")
        ]);
        const data = await resp.json();
        const hora = new Date((await horaResp.json()).utc_datetime);
        const user = data.usuarios.find(u => u.correo === correo && u.codigo === codigo);
        if (!user) return alert("ID no válido.");
        const expira = new Date(user.expira);
        if (hora > expira) return alert("Tu acceso expiró.");
        document.getElementById("acceso").style.display = "none";
        document.getElementById("contenido").style.display = "block";
      } catch (e) {
        alert("Error de conexión al validar.");
      }
    }
function ocultar() {
      const mensaje = document.getElementById("mensaje").value.trim();
      const clave = document.getElementById("clave").value;
      const archivo = document.getElementById("imagenInput").files[0];
      if (!mensaje || !clave || !archivo) return alert("Faltan datos");
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          const canvas = document.getElementById("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          const cifrado = CryptoJS.AES.encrypt(mensaje, clave).toString();
          const binario = Array.from(cifrado).map(c =>
            c.charCodeAt(0).toString(2).padStart(8, '0')).join('') + '00000000';
          const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imgData.data;
          if (binario.length > data.length) return alert("Mensaje demasiado largo");
          for (let i = 0; i < binario.length; i++) {
            data[i] = (data[i] & ~1) | parseInt(binario[i]);
          }
          ctx.putImageData(imgData, 0, 0);
          const nuevaImg = canvas.toDataURL();
          document.getElementById("result").innerHTML = `
            <p>Imagen con mensaje oculto:</p>
            <a href="${nuevaImg}" download="secreto.png">Descargar imagen</a><br>
            <img src="${nuevaImg}">
          `;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(archivo);
    }

    function leer() {
      const archivo = document.getElementById("imagenLectura").files[0];
      const clave = document.getElementById("claveLectura").value;
      const salida = document.getElementById("mensajeSalida");
      if (!archivo || !clave) return alert("Faltan datos");
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          const canvas = document.getElementById("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
          let bin = "", i = 0;
          while (i < data.length) {
            bin += (data[i] & 1);
            if (bin.slice(-8) === "00000000") break;
            i++;
          }
          let str = "";
          for (let j = 0; j < bin.length - 8; j += 8) {
            str += String.fromCharCode(parseInt(bin.slice(j, j + 8), 2));
          }
          try {
            const descifrado = CryptoJS.AES.decrypt(str, clave).toString(CryptoJS.enc.Utf8);
            salida.value = descifrado || "[Mensaje ilegible o clave incorrecta]";
          } catch {
            salida.value = "[Error al descifrar]";
          }
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(archivo);
    }

    function editar() {
      const texto = document.getElementById("mensajeSalida").value;
      document.getElementById("mensaje").value = texto;
      window.scrollTo(0, 0);
    }
  </script>
</body>
</html>
